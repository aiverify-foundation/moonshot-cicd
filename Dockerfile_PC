# --- Stage 1: Build a static Python app ---
FROM python:3.12-slim as builder

WORKDIR /app

# Install Poetry and dependencies
COPY pyproject.toml poetry.lock README.md ./
RUN pip install poetry==1.8.2 && \
    poetry config virtualenvs.create false && \
    poetry install --only process_checks --no-root

# Copy source code
COPY process_check_app/ .

# --- Stage 2: Static distroless ---
FROM gcr.io/distroless/base-debian12

WORKDIR /app

# Copy statically linked Python binary
COPY --from=builder /usr/local/bin/python3.12 /usr/local/bin/python3.12
COPY --from=builder /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages

COPY --from=builder /app /app

CMD ["/usr/local/bin/python3.12", "streamlit_app.py"]